# メール機能仕様書

## 概要

本APIでは、ユーザー登録、パスワードリセット、通知などの目的でメール機能を使用します。このドキュメントでは、メール機能の仕様、使用方法、および実装詳細について説明します。

## メール送信機能

### 対応メール種別

1. **ユーザー登録確認メール**
   - 新規ユーザー登録時に送信
   - 登録完了の案内とサービス紹介

2. **パスワードリセットメール**
   - パスワードリセット要求時に送信
   - リセット用URLを含む

3. **システム通知メール**
   - 重要なシステム通知をユーザーに送信
   - サービス更新情報など

### メール送信の流れ

1. アプリケーション内部でメール送信要求が発生
2. メールテンプレートが選択され、必要なデータでパラメータ展開
3. SMTPサーバーを使用してメールが送信
4. 送信結果がログに出力され、必要に応じてデータベースに記録

## メール設定

### 環境変数

| 変数名 | 説明 |
|--------|------|
| `SMTP_HOST` | SMTPサーバーホスト |
| `SMTP_PORT` | SMTPサーバーポート |
| `SMTP_USERNAME` | SMTP認証ユーザー名 |
| `SMTP_PASSWORD` | SMTP認証パスワード |
| `SMTP_ENCRYPTION` | 暗号化方式 (STARTTLS or SSL) |
| `DEFAULT_FROM_EMAIL` | 送信元メールアドレス |

### メールテンプレート

メールテンプレートはHTML形式で定義され、以下のような構造を持っています：

```
templates/
├── welcome.html
├── password_reset.html
└── notification.html
```

各テンプレートには、動的に置換されるパラメータが含まれます。

## 実装詳細

### メール送信サービス

メール送信機能は、`mail_service.rs`で定義されたサービスを使用します。このサービスは非同期で動作し、SMTPサーバーとの通信を処理します。

### エラーハンドリング

- SMTPサーバーへの接続失敗
- 認証エラー
- 送信先アドレスの不正
- ネットワークエラー

これらのエラーは適切にキャッチされ、ログに出力されます。

### テスト

メール送信機能のテストは、実際のメール送信を行わずモックSMTPサーバーを使用して行われます。これにより、テスト時の副作用を防ぎつつ、機能の検証を行います。

## セキュリティ対策

- 送信先メールアドレスの検証
- メールインジェクション対策
- メールテンプレートのサニタイズ
- SMTP認証情報の安全な保管

## ロギング

メール送信に関するログは、以下のように記録されます：

- 送信成功/失敗
- 送信先アドレス（一部マスキング）
- 送信時刻
- メール種別

## パフォーマンスに関する考慮事項

- メール送信は非同期で行われ、リクエストのレスポンスタイムに影響を与えない
- 大量メール送信時はキューイング機構を使用
- SMTPコネクションプールを使用して効率化

## FAQ

### Q: メールが届かない場合の確認方法は？

A: 以下の点を確認してください：
1. SMTPサーバーの設定が正しいか
2. ファイアウォールでSMTPポートがブロックされていないか
3. 送信先メールアドレスが有効かどうか
4. ログにエラーメッセージがないか

### Q: メールテンプレートのカスタマイズは可能ですか？

A: はい、`templates/`ディレクトリ内のHTMLファイルを編集することでカスタマイズ可能です。ただし、パラメータプレースホルダーは変更しないでください。